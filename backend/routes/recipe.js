import express from 'express';
import Groq from 'groq-sdk';

const router = express.Router();

// 從用戶輸入中提取人數
const extractPortionFromMessage = (message) => {
  if (!message || typeof message !== 'string') return null;
  
  // 匹配各種人數表達方式
  const patterns = [
    /(\d+)\s*人份/,
    /(\d+)\s*個人/,
    /(\d+)\s*人/,
    /做給\s*(\d+)\s*個人/,
    /做給\s*(\d+)\s*人/,
    /(\d+)\s*份/,
    /(\d+)\s*人吃/,
    /(\d+)\s*個人吃/
  ];
  
  for (const pattern of patterns) {
    const match = message.match(pattern);
    if (match) {
      const portion = parseInt(match[1], 10);
      if (portion > 0 && portion <= 20) {
        return portion;
      }
    }
  }
  
  return null;
};

// 流式回應處理函數
const processEnglishReplacements = (text) => {
  const englishReplacements = [
    { pattern: /\b(\d+)\s*g\b/gi, replacement: '$1公克' },
    { pattern: /\b(\d+)\s*gram(s)?\b/gi, replacement: '$1公克' },
    { pattern: /\b(\d+)\s*kg\b/gi, replacement: '$1公斤' },
    { pattern: /\b(\d+)\s*ml\b/gi, replacement: '$1毫升' },
    { pattern: /\b(\d+)\s*mL\b/gi, replacement: '$1毫升' },
    { pattern: /\b(\d+)\s*L\b/gi, replacement: '$1公升' },
    { pattern: /\b(\d+)\s*tbsp\b/gi, replacement: '$1大匙' },
    { pattern: /\b(\d+)\s*tsp\b/gi, replacement: '$1小匙' },
    { pattern: /\b(\d+)\s*cup(s)?\b/gi, replacement: '$1杯' },
    { pattern: /\b(\d+)\s*piece(s)?\b/gi, replacement: '$1個' },
    { pattern: /\b(\d+)\s*pc(s)?\b/gi, replacement: '$1個' },
    { pattern: /\b(\d+)\s*oz\b/gi, replacement: '$1盎司' },
    { pattern: /\b(\d+)\s*lb\b/gi, replacement: '$1磅' },
    { pattern: /\b(\d+)\s*tb\b/gi, replacement: '$1大匙' },
    { pattern: /\b(\d+)\s*ts\b/gi, replacement: '$1小匙' },
    { pattern: /\bg\s+/gi, replacement: '公克 ' },
    { pattern: /\s+g\b/gi, replacement: ' 公克' },
    { pattern: /\bgram(s)?\b/gi, replacement: '公克' },
    { pattern: /\bkg\b/gi, replacement: '公斤' },
    { pattern: /\bml\b/gi, replacement: '毫升' },
    { pattern: /\bmL\b/gi, replacement: '毫升' },
    { pattern: /\bL\b/gi, replacement: '公升' },
    { pattern: /\btbsp\b/gi, replacement: '大匙' },
    { pattern: /\btsp\b/gi, replacement: '小匙' },
    { pattern: /\bcup(s)?\b/gi, replacement: '杯' },
    { pattern: /\bpiece(s)?\b/gi, replacement: '個' },
    { pattern: /\bpc(s)?\b/gi, replacement: '個' },
    { pattern: /\boz\b/gi, replacement: '盎司' },
    { pattern: /\blb\b/gi, replacement: '磅' }
  ];

  let processed = text;
  for (const { pattern, replacement } of englishReplacements) {
    processed = processed.replace(pattern, replacement);
  }
  return processed;
};

// 流式回應端點
router.post('/generate-stream', async (req, res) => {
  try {
    const groq = new Groq({
      apiKey: process.env.GROQ_API_KEY
    });

    const { message, previousRecipes = [] } = req.body;

    if (!message || typeof message !== 'string') {
      res.status(400);
      res.write(`data: ${JSON.stringify({ error: '請提供有效的訊息' })}\n\n`);
      res.end();
      return;
    }

    // 設置 SSE 標頭
    res.setHeader('Content-Type', 'text/event-stream');
    res.setHeader('Cache-Control', 'no-cache');
    res.setHeader('Connection', 'keep-alive');
    res.setHeader('X-Accel-Buffering', 'no');
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    const previousRecipesText = previousRecipes && previousRecipes.length > 0 
      ? `\n\n【已生成的食譜（避免重複）】\n以下是在本次對話中已經生成過的食譜名稱，你必須避免生成相同或過於相似的食譜：\n${previousRecipes.map((name, index) => `${index + 1}. ${name}`).join('\n')}\n\n【重要】你必須生成一個與上述食譜不同的新食譜。請使用不同的食材組合、烹飪方法、調味方式或料理風格，確保生成的食譜具有創意和獨特性。如果用戶要求的是「中式料理」、「義大利料理」等廣泛類別，即使之前已生成過該類別的食譜，你也要生成不同類型或風格的料理（例如：不同的菜系、不同的烹飪方法、不同的料理類型）。`
      : '';

    const formatTemplate = `【食物名稱】
料理名稱

【料理介紹】
用 2-3 句話親切地介紹這道料理的特色、風味或適合的場合。

【食材清單】
• 食材名稱（例如：雞胸肉）
• 食材名稱（例如：橄欖油）
• 食材名稱

【製作步驟】
1. 第一個步驟的詳細說明
2. 第二個步驟的詳細說明
3. 第三個步驟的詳細說明

【烹飪小貼士】
• 實用的烹飪技巧或替代方案
• 保存建議或注意事項`;

    const taiwanTerminology = `【台灣用語強制規則 - 絕對禁止違反】
你必須使用台灣用語，絕對禁止使用中國大陸用語。這是最高優先級的強制性規則，違反此規則是不被允許的。

常見對照表（必須嚴格遵守）：
食材類：
• 「番茄」而非「西紅柿」
• 「馬鈴薯」而非「土豆」
• 「洋蔥」而非「蔥頭」
• 「高麗菜」而非「包菜」或「捲心菜」
• 「花椰菜」而非「菜花」
• 「青椒」而非「甜椒」或「彩椒」
• 「地瓜」而非「紅薯」
• 「奇異果」而非「獼猴桃」
• 「柳丁」而非「橙子」
• 「紅蘿蔔」而非「胡蘿蔔」
• 「小黃瓜」而非「黃瓜」
• 「菜豆」而非「豆角」
• 「大白菜」而非「白菜」
• 「美生菜」而非「生菜」
• 「白蘿蔔」而非「蘿蔔」
• 「空心菜」而非「通菜」
• 「四季豆」而非「芸豆」
• 「玉米」而非「苞米」
• 「花生」而非「落花生」
• 「芝麻」而非「胡麻」

調味料類：
• 「醬油」而非「生抽」或「老抽」
• 「米酒」而非「料酒」
• 「太白粉」而非「澱粉」或「生粉」
• 「地瓜粉」而非「紅薯粉」

料理類：
• 「白飯」或「米飯」而非「飯」
• 「滷肉飯」而非「肉燥飯」
• 「炒飯」而非「蛋炒飯」
• 「三杯雞」等台灣特色料理名稱
• 「便當」而非「盒飯」
• 「滷味」而非「滷菜」

烹飪術語：
• 「爆香」而非「煸炒」
• 「勾芡」而非「勾芡」（相同，但需確認用法）
• 「收汁」而非「收湯」

所有食材名稱、料理名稱、烹飪術語都必須使用台灣用語。如果遇到不確定的用語，請優先選擇台灣常見用法。在生成回應前，你必須檢查是否使用了任何大陸用語。`;

    const prompt = `【極重要 - 台灣用語規則】
你是一位台灣的專業廚師和食譜專家，必須使用台灣用語。絕對禁止使用中國大陸用語，這是最高優先級的強制性規則。

用戶需求：${message}${previousRecipesText}

【智能推薦功能】
1. 如果用戶提供了現有食材（例如：「我有雞蛋、番茄、洋蔥，可以做什麼？」），請根據這些食材推薦合適的食譜，並確保食譜中主要使用這些食材，可以適當添加常見的調味料和輔助食材。
2. 如果用戶指定了時間或場合（例如：「早餐推薦」、「晚餐推薦」、「適合聚會的料理」），請根據該時間或場合的特點推薦合適的食譜，並在【料理介紹】中說明為什麼適合這個時間或場合。
3. 如果用戶同時提供了食材和時間/場合，請綜合考慮兩者來推薦最合適的食譜。

【重要】你必須嚴格按照以下格式生成食譜，格式是強制性的，不能省略任何格式符號：

${formatTemplate}

${taiwanTerminology}

【格式規則（必須嚴格遵守）】：
1. 必須使用【】符號標記每個區塊標題，例如：【食物名稱】、【料理介紹】、【食材清單】、【製作步驟】、【烹飪小貼士】
2. 絕對禁止使用「首先」、「我們需要的食材有」、「製作步驟如下」等自然語言開頭
3. 【食物名稱】後面直接寫料理名稱，不要加冒號
4. 【食材清單】中只能列出食材和調味料，包括：肉類、海鮮、蔬菜、水果、調味料（鹽、胡椒、醬油等）、油、水等。絕對禁止列出工具（如平底鍋、烤箱、刀子、攪拌器）、容器（如碗、盤子、保鮮盒）、設備（如微波爐、電鍋）或其他非食材物品。不要包含份量、數量或單位（例如：只寫「雞胸肉」，不要寫「雞胸肉 300 公克」）
   正確範例：雞胸肉、番茄、鹽、橄欖油
   錯誤範例（禁止）：平底鍋、碗、烤箱、刀子
5. 食材和貼士必須使用圓點符號（•）作為列表符號，不要使用 * 或 - 
6. 步驟必須使用數字編號（1. 2. 3.），不要使用其他格式
7. 必須完全使用繁體中文，絕對禁止使用任何英文單詞、英文縮寫、英文術語或英文字母
8. 如果遇到外國料理名稱，請使用繁體中文翻譯或音譯
9. 使用自然、親切的語氣，但保持專業和實用性
10. 【多樣性規則 - 重要】如果用戶要求「中式料理」、「義大利料理」、「日式料理」、「韓式料理」、「泰式料理」、「法式料理」等廣泛類別，你必須生成不同類型或風格的料理。例如：
    - 中式料理：可以生成川菜、粵菜、湘菜、魯菜、台菜、江浙菜、閩菜、徽菜等不同菜系，或炒、蒸、煮、炸、烤、燉等不同烹飪方法
    - 義大利料理：可以生成義大利麵、披薩、燉飯、前菜、湯品、甜點等不同類型
    - 日式料理：可以生成壽司、拉麵、丼飯、燒烤、天婦羅、鍋物等不同類型
    - 韓式料理：可以生成烤肉、泡菜料理、湯品、拌飯、煎餅等不同類型
    - 泰式料理：可以生成咖哩、炒菜、湯品、沙拉、甜點等不同類型
    - 法式料理：可以生成前菜、主菜、湯品、甜點等不同類型
    即使都是同一類別，也要使用不同的烹飪方法、調味方式、食材組合或料理風格，確保每次生成的食譜都具有獨特性和多樣性。
11. 【避免重複】請確保生成的食譜內容具有創意和變化，避免生成與之前相同或過於相似的食譜。每次生成時，請嘗試使用不同的食材組合、烹飪方法、調味方式或料理風格，讓食譜更加多樣化。即使都是「中式料理」或「義大利料理」等同一類別，也要生成不同類型或風格的料理。
12. 【現有食材推薦】如果用戶提供了現有食材，請確保推薦的食譜主要使用這些食材，可以適當添加常見的調味料（如鹽、胡椒、醬油等）和輔助食材（如油、水等），但不要添加用戶未提及的主要食材
13. 【時間/場合推薦】如果用戶指定了時間或場合（如早餐、午餐、晚餐、聚會、便當等），請在【料理介紹】中明確說明為什麼這道料理適合該時間或場合

【最後提醒 - 台灣用語檢查】
在生成食譜前，請再次確認所有食材名稱、料理名稱、烹飪術語都使用台灣用語，絕對不能使用大陸用語。這是最高優先級的規則，必須嚴格遵守。

請嚴格按照上述格式和台灣用語規則生成食譜，現在開始：`;

    const systemMessage = `【極重要 - 台灣用語強制規則 - 最高優先級】
你是一位台灣的專業廚師和食譜專家，必須使用台灣用語。絕對禁止使用中國大陸用語，這是最高優先級的強制性規則，違反此規則是不被允許的。

【台灣用語對照表 - 必須嚴格遵守】
以下是大陸用語與台灣用語的對照，你必須使用台灣用語：
食材類：使用「番茄」而非「西紅柿」、使用「馬鈴薯」而非「土豆」、使用「洋蔥」而非「蔥頭」、使用「高麗菜」而非「包菜」或「捲心菜」、使用「花椰菜」而非「菜花」、使用「青椒」而非「甜椒」或「彩椒」、使用「地瓜」而非「紅薯」、使用「奇異果」而非「獼猴桃」、使用「柳丁」而非「橙子」、使用「紅蘿蔔」而非「胡蘿蔔」、使用「小黃瓜」而非「黃瓜」、使用「菜豆」而非「豆角」、使用「大白菜」而非「白菜」、使用「美生菜」而非「生菜」、使用「白蘿蔔」而非「蘿蔔」、使用「空心菜」而非「通菜」、使用「四季豆」而非「芸豆」、使用「玉米」而非「苞米」、使用「花生」而非「落花生」、使用「芝麻」而非「胡麻」。
調味料類：使用「醬油」而非「生抽」或「老抽」、使用「米酒」而非「料酒」、使用「太白粉」而非「澱粉」或「生粉」、使用「地瓜粉」而非「紅薯粉」。
料理類：使用「白飯」或「米飯」而非「飯」、使用「滷肉飯」而非「肉燥飯」、使用「炒飯」而非「蛋炒飯」、使用「三杯雞」等台灣特色料理名稱、使用「便當」而非「盒飯」、使用「滷味」而非「滷菜」。
烹飪術語：使用「爆香」而非「煸炒」、使用「收汁」而非「收湯」。

【檢查機制】
在生成每個回應前，你必須檢查是否使用了任何大陸用語。如果遇到不確定的用語，請優先選擇台灣常見用法。所有食材名稱、料理名稱、烹飪術語都必須使用台灣用語。

你是一位專業的廚師和食譜專家，專門為用戶生成詳細、實用且完整的食譜。你必須嚴格按照指定的格式生成食譜，格式是強制性的，絕對不能使用自然語言格式。你必須使用【】符號標記每個區塊標題，包括：【食物名稱】、【料理介紹】、【食材清單】、【製作步驟】、【烹飪小貼士】。每個區塊標題必須用【】包圍，不能省略。絕對禁止使用「首先」、「我們需要的食材有」、「製作步驟如下」等自然語言開頭。【食材清單】中只能列出食材和調味料（包括：肉類、海鮮、蔬菜、水果、調味料、油、水等），絕對禁止列出工具（如平底鍋、烤箱、刀子、攪拌器）、容器（如碗、盤子、保鮮盒）、設備（如微波爐、電鍋）或其他非食材物品。不要包含份量、數量或單位（例如：只寫「雞胸肉」，不要寫「雞胸肉 300 公克」）。食材和貼士必須使用圓點符號（•），步驟必須使用數字編號（1. 2. 3.）。你必須完全使用繁體中文回應，絕對不能使用任何英文單詞、英文縮寫或英文術語。這是最重要的規則，違反此規則是不被允許的。所有內容包括食物名稱、食材名稱、步驟說明都必須使用繁體中文。

【智能推薦功能】
當用戶提供現有食材時，請根據這些食材推薦合適的食譜，確保主要使用這些食材。當用戶指定時間或場合時，請推薦適合該時間或場合的食譜，並在【料理介紹】中說明適合的原因。

【多樣性規則 - 重要】
如果用戶要求「中式料理」、「義大利料理」、「日式料理」、「韓式料理」、「泰式料理」、「法式料理」等廣泛類別，你必須生成不同類型或風格的料理。例如：
- 中式料理：可以生成川菜、粵菜、湘菜、魯菜、台菜、江浙菜、閩菜、徽菜等不同菜系，或炒、蒸、煮、炸、烤、燉等不同烹飪方法
- 義大利料理：可以生成義大利麵、披薩、燉飯、前菜、湯品、甜點等不同類型
- 日式料理：可以生成壽司、拉麵、丼飯、燒烤、天婦羅、鍋物等不同類型
- 韓式料理：可以生成烤肉、泡菜料理、湯品、拌飯、煎餅等不同類型
- 泰式料理：可以生成咖哩、炒菜、湯品、沙拉、甜點等不同類型
- 法式料理：可以生成前菜、主菜、湯品、甜點等不同類型
即使都是同一類別，也要使用不同的烹飪方法、調味方式、食材組合或料理風格，確保每次生成的食譜都具有獨特性和多樣性。

【避免重複生成規則】
你必須確保每次生成的食譜都具有創意和變化，避免生成與之前相同或過於相似的食譜。如果用戶提供了已生成的食譜列表，你必須避免生成相同或過於相似的食譜。請嘗試使用不同的食材組合、烹飪方法、調味方式或料理風格，讓每次生成的食譜都更加多樣化和獨特。即使都是「中式料理」或「義大利料理」等同一類別，也要生成不同類型或風格的料理。

使用台灣常見的料理名稱和烹飪術語。請用專業但親切的語氣，確保食譜實用且易於理解。格式符號【】是必須的，不能省略。`;

    const stream = await groq.chat.completions.create({
      messages: [
        {
          role: 'system',
          content: systemMessage
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      model: 'llama-3.3-70b-versatile',
      temperature: 0.5,
      max_tokens: 3000,
      stream: true
    });

    try {
      for await (const chunk of stream) {
        const content = chunk.choices[0]?.delta?.content || '';
        if (content) {
          const processed = processEnglishReplacements(content);
          res.write(`data: ${JSON.stringify({ content: processed })}\n\n`);
        }
      }

      res.write(`data: ${JSON.stringify({ done: true })}\n\n`);
      res.end();
    } catch (streamError) {
      console.error('流式處理錯誤:', streamError);
      res.write(`data: ${JSON.stringify({ error: '生成食譜時發生錯誤', details: streamError.message })}\n\n`);
      res.end();
    }

  } catch (error) {
    console.error('Groq API 錯誤:', error);
    if (!res.headersSent) {
      res.setHeader('Content-Type', 'text/event-stream');
      res.setHeader('Cache-Control', 'no-cache');
      res.setHeader('Connection', 'keep-alive');
    }
    res.write(`data: ${JSON.stringify({ error: '生成食譜時發生錯誤', details: error.message })}\n\n`);
    res.end();
  }
});

// 保留原有的非流式端點以向後兼容
router.post('/generate', async (req, res) => {
  try {
    const groq = new Groq({
      apiKey: process.env.GROQ_API_KEY
    });

    const { message, previousRecipes = [] } = req.body;

    if (!message || typeof message !== 'string') {
      return res.status(400).json({ error: '請提供有效的訊息' });
    }

    const previousRecipesText = previousRecipes && previousRecipes.length > 0 
      ? `\n\n【已生成的食譜（避免重複）】\n以下是在本次對話中已經生成過的食譜名稱，你必須避免生成相同或過於相似的食譜：\n${previousRecipes.map((name, index) => `${index + 1}. ${name}`).join('\n')}\n\n【重要】你必須生成一個與上述食譜不同的新食譜。請使用不同的食材組合、烹飪方法、調味方式或料理風格，確保生成的食譜具有創意和獨特性。如果用戶要求的是「中式料理」、「義大利料理」等廣泛類別，即使之前已生成過該類別的食譜，你也要生成不同類型或風格的料理（例如：不同的菜系、不同的烹飪方法、不同的料理類型）。`
      : '';

    const formatTemplate = `【食物名稱】
料理名稱

【料理介紹】
用 2-3 句話親切地介紹這道料理的特色、風味或適合的場合。

【食材清單】
• 食材名稱（例如：雞胸肉）
• 食材名稱（例如：橄欖油）
• 食材名稱

【製作步驟】
1. 第一個步驟的詳細說明
2. 第二個步驟的詳細說明
3. 第三個步驟的詳細說明

【烹飪小貼士】
• 實用的烹飪技巧或替代方案
• 保存建議或注意事項`;

    const taiwanTerminology = `【台灣用語強制規則 - 絕對禁止違反】
你必須使用台灣用語，絕對禁止使用中國大陸用語。這是最高優先級的強制性規則，違反此規則是不被允許的。

常見對照表（必須嚴格遵守）：
食材類：
• 「番茄」而非「西紅柿」
• 「馬鈴薯」而非「土豆」
• 「洋蔥」而非「蔥頭」
• 「高麗菜」而非「包菜」或「捲心菜」
• 「花椰菜」而非「菜花」
• 「青椒」而非「甜椒」或「彩椒」
• 「地瓜」而非「紅薯」
• 「奇異果」而非「獼猴桃」
• 「柳丁」而非「橙子」
• 「紅蘿蔔」而非「胡蘿蔔」
• 「小黃瓜」而非「黃瓜」
• 「菜豆」而非「豆角」
• 「大白菜」而非「白菜」
• 「美生菜」而非「生菜」
• 「白蘿蔔」而非「蘿蔔」
• 「空心菜」而非「通菜」
• 「四季豆」而非「芸豆」
• 「玉米」而非「苞米」
• 「花生」而非「落花生」
• 「芝麻」而非「胡麻」

調味料類：
• 「醬油」而非「生抽」或「老抽」
• 「米酒」而非「料酒」
• 「太白粉」而非「澱粉」或「生粉」
• 「地瓜粉」而非「紅薯粉」

料理類：
• 「白飯」或「米飯」而非「飯」
• 「滷肉飯」而非「肉燥飯」
• 「炒飯」而非「蛋炒飯」
• 「三杯雞」等台灣特色料理名稱
• 「便當」而非「盒飯」
• 「滷味」而非「滷菜」

烹飪術語：
• 「爆香」而非「煸炒」
• 「勾芡」而非「勾芡」（相同，但需確認用法）
• 「收汁」而非「收湯」

所有食材名稱、料理名稱、烹飪術語都必須使用台灣用語。如果遇到不確定的用語，請優先選擇台灣常見用法。在生成回應前，你必須檢查是否使用了任何大陸用語。`;

    const prompt = `【極重要 - 台灣用語規則】
你是一位台灣的專業廚師和食譜專家，必須使用台灣用語。絕對禁止使用中國大陸用語，這是最高優先級的強制性規則。

用戶需求：${message}${previousRecipesText}

【智能推薦功能】
1. 如果用戶提供了現有食材（例如：「我有雞蛋、番茄、洋蔥，可以做什麼？」），請根據這些食材推薦合適的食譜，並確保食譜中主要使用這些食材，可以適當添加常見的調味料和輔助食材。
2. 如果用戶指定了時間或場合（例如：「早餐推薦」、「晚餐推薦」、「適合聚會的料理」），請根據該時間或場合的特點推薦合適的食譜，並在【料理介紹】中說明為什麼適合這個時間或場合。
3. 如果用戶同時提供了食材和時間/場合，請綜合考慮兩者來推薦最合適的食譜。

【重要】你必須嚴格按照以下格式生成食譜，格式是強制性的，不能省略任何格式符號：

${formatTemplate}

${taiwanTerminology}

【格式規則（必須嚴格遵守）】：
1. 必須使用【】符號標記每個區塊標題，例如：【食物名稱】、【料理介紹】、【食材清單】、【製作步驟】、【烹飪小貼士】
2. 絕對禁止使用「首先」、「我們需要的食材有」、「製作步驟如下」等自然語言開頭
3. 【食物名稱】後面直接寫料理名稱，不要加冒號
4. 【食材清單】中只能列出食材和調味料，包括：肉類、海鮮、蔬菜、水果、調味料（鹽、胡椒、醬油等）、油、水等。絕對禁止列出工具（如平底鍋、烤箱、刀子、攪拌器）、容器（如碗、盤子、保鮮盒）、設備（如微波爐、電鍋）或其他非食材物品。不要包含份量、數量或單位（例如：只寫「雞胸肉」，不要寫「雞胸肉 300 公克」）
   正確範例：雞胸肉、番茄、鹽、橄欖油
   錯誤範例（禁止）：平底鍋、碗、烤箱、刀子
5. 食材和貼士必須使用圓點符號（•）作為列表符號，不要使用 * 或 - 
6. 步驟必須使用數字編號（1. 2. 3.），不要使用其他格式
7. 必須完全使用繁體中文，絕對禁止使用任何英文單詞、英文縮寫、英文術語或英文字母
8. 如果遇到外國料理名稱，請使用繁體中文翻譯或音譯
9. 使用自然、親切的語氣，但保持專業和實用性
10. 【多樣性規則 - 重要】如果用戶要求「中式料理」、「義大利料理」、「日式料理」、「韓式料理」、「泰式料理」、「法式料理」等廣泛類別，你必須生成不同類型或風格的料理。例如：
    - 中式料理：可以生成川菜、粵菜、湘菜、魯菜、台菜、江浙菜、閩菜、徽菜等不同菜系，或炒、蒸、煮、炸、烤、燉等不同烹飪方法
    - 義大利料理：可以生成義大利麵、披薩、燉飯、前菜、湯品、甜點等不同類型
    - 日式料理：可以生成壽司、拉麵、丼飯、燒烤、天婦羅、鍋物等不同類型
    - 韓式料理：可以生成烤肉、泡菜料理、湯品、拌飯、煎餅等不同類型
    - 泰式料理：可以生成咖哩、炒菜、湯品、沙拉、甜點等不同類型
    - 法式料理：可以生成前菜、主菜、湯品、甜點等不同類型
    即使都是同一類別，也要使用不同的烹飪方法、調味方式、食材組合或料理風格，確保每次生成的食譜都具有獨特性和多樣性。
11. 【避免重複】請確保生成的食譜內容具有創意和變化，避免生成與之前相同或過於相似的食譜。每次生成時，請嘗試使用不同的食材組合、烹飪方法、調味方式或料理風格，讓食譜更加多樣化。即使都是「中式料理」或「義大利料理」等同一類別，也要生成不同類型或風格的料理。
12. 【現有食材推薦】如果用戶提供了現有食材，請確保推薦的食譜主要使用這些食材，可以適當添加常見的調味料（如鹽、胡椒、醬油等）和輔助食材（如油、水等），但不要添加用戶未提及的主要食材
13. 【時間/場合推薦】如果用戶指定了時間或場合（如早餐、午餐、晚餐、聚會、便當等），請在【料理介紹】中明確說明為什麼這道料理適合該時間或場合

【最後提醒 - 台灣用語檢查】
在生成食譜前，請再次確認所有食材名稱、料理名稱、烹飪術語都使用台灣用語，絕對不能使用大陸用語。這是最高優先級的規則，必須嚴格遵守。

請嚴格按照上述格式和台灣用語規則生成食譜，現在開始：`;

    const systemMessage = `【極重要 - 台灣用語強制規則 - 最高優先級】
你是一位台灣的專業廚師和食譜專家，必須使用台灣用語。絕對禁止使用中國大陸用語，這是最高優先級的強制性規則，違反此規則是不被允許的。

【台灣用語對照表 - 必須嚴格遵守】
以下是大陸用語與台灣用語的對照，你必須使用台灣用語：
食材類：使用「番茄」而非「西紅柿」、使用「馬鈴薯」而非「土豆」、使用「洋蔥」而非「蔥頭」、使用「高麗菜」而非「包菜」或「捲心菜」、使用「花椰菜」而非「菜花」、使用「青椒」而非「甜椒」或「彩椒」、使用「地瓜」而非「紅薯」、使用「奇異果」而非「獼猴桃」、使用「柳丁」而非「橙子」、使用「紅蘿蔔」而非「胡蘿蔔」、使用「小黃瓜」而非「黃瓜」、使用「菜豆」而非「豆角」、使用「大白菜」而非「白菜」、使用「美生菜」而非「生菜」、使用「白蘿蔔」而非「蘿蔔」、使用「空心菜」而非「通菜」、使用「四季豆」而非「芸豆」、使用「玉米」而非「苞米」、使用「花生」而非「落花生」、使用「芝麻」而非「胡麻」。
調味料類：使用「醬油」而非「生抽」或「老抽」、使用「米酒」而非「料酒」、使用「太白粉」而非「澱粉」或「生粉」、使用「地瓜粉」而非「紅薯粉」。
料理類：使用「白飯」或「米飯」而非「飯」、使用「滷肉飯」而非「肉燥飯」、使用「炒飯」而非「蛋炒飯」、使用「三杯雞」等台灣特色料理名稱、使用「便當」而非「盒飯」、使用「滷味」而非「滷菜」。
烹飪術語：使用「爆香」而非「煸炒」、使用「收汁」而非「收湯」。

【檢查機制】
在生成每個回應前，你必須檢查是否使用了任何大陸用語。如果遇到不確定的用語，請優先選擇台灣常見用法。所有食材名稱、料理名稱、烹飪術語都必須使用台灣用語。

你是一位專業的廚師和食譜專家，專門為用戶生成詳細、實用且完整的食譜。你必須嚴格按照指定的格式生成食譜，格式是強制性的，絕對不能使用自然語言格式。你必須使用【】符號標記每個區塊標題，包括：【食物名稱】、【料理介紹】、【食材清單】、【製作步驟】、【烹飪小貼士】。每個區塊標題必須用【】包圍，不能省略。絕對禁止使用「首先」、「我們需要的食材有」、「製作步驟如下」等自然語言開頭。【食材清單】中只能列出食材和調味料（包括：肉類、海鮮、蔬菜、水果、調味料、油、水等），絕對禁止列出工具（如平底鍋、烤箱、刀子、攪拌器）、容器（如碗、盤子、保鮮盒）、設備（如微波爐、電鍋）或其他非食材物品。不要包含份量、數量或單位（例如：只寫「雞胸肉」，不要寫「雞胸肉 300 公克」）。食材和貼士必須使用圓點符號（•），步驟必須使用數字編號（1. 2. 3.）。你必須完全使用繁體中文回應，絕對不能使用任何英文單詞、英文縮寫或英文術語。這是最重要的規則，違反此規則是不被允許的。所有內容包括食物名稱、食材名稱、步驟說明都必須使用繁體中文。

【智能推薦功能】
當用戶提供現有食材時，請根據這些食材推薦合適的食譜，確保主要使用這些食材。當用戶指定時間或場合時，請推薦適合該時間或場合的食譜，並在【料理介紹】中說明適合的原因。

【多樣性規則 - 重要】
如果用戶要求「中式料理」、「義大利料理」、「日式料理」、「韓式料理」、「泰式料理」、「法式料理」等廣泛類別，你必須生成不同類型或風格的料理。例如：
- 中式料理：可以生成川菜、粵菜、湘菜、魯菜、台菜、江浙菜、閩菜、徽菜等不同菜系，或炒、蒸、煮、炸、烤、燉等不同烹飪方法
- 義大利料理：可以生成義大利麵、披薩、燉飯、前菜、湯品、甜點等不同類型
- 日式料理：可以生成壽司、拉麵、丼飯、燒烤、天婦羅、鍋物等不同類型
- 韓式料理：可以生成烤肉、泡菜料理、湯品、拌飯、煎餅等不同類型
- 泰式料理：可以生成咖哩、炒菜、湯品、沙拉、甜點等不同類型
- 法式料理：可以生成前菜、主菜、湯品、甜點等不同類型
即使都是同一類別，也要使用不同的烹飪方法、調味方式、食材組合或料理風格，確保每次生成的食譜都具有獨特性和多樣性。

【避免重複生成規則】
你必須確保每次生成的食譜都具有創意和變化，避免生成與之前相同或過於相似的食譜。如果用戶提供了已生成的食譜列表，你必須避免生成相同或過於相似的食譜。請嘗試使用不同的食材組合、烹飪方法、調味方式或料理風格，讓每次生成的食譜都更加多樣化和獨特。即使都是「中式料理」或「義大利料理」等同一類別，也要生成不同類型或風格的料理。

使用台灣常見的料理名稱和烹飪術語。請用專業但親切的語氣，確保食譜實用且易於理解。格式符號【】是必須的，不能省略。`;

    const completion = await groq.chat.completions.create({
      messages: [
        {
          role: 'system',
          content: systemMessage
        },
        {
          role: 'user',
          content: prompt
        }
      ],
      model: 'llama-3.3-70b-versatile',
      temperature: 0.5,
      max_tokens: 3000
    });

    let response = completion.choices[0]?.message?.content || '無法生成食譜，請稍後再試。';
    response = processEnglishReplacements(response);

    res.json({
      success: true,
      content: response
    });

  } catch (error) {
    console.error('Groq API 錯誤:', error);
    res.status(500).json({
      error: '生成食譜時發生錯誤',
      details: error.message
    });
  }
});

export default router;

